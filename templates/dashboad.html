<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:site_name" content="https://mcc.backup.miracle44radio.com/dashboard">
    <meta property="og:title" content="Data Center">
    <meta property="og:description"
        content="Welcome to Robert Kayanja Backup Centre. login to store your Files">
    <meta property="og:image" itemprop="image"
    content="https://mcc.backup.miracle44radio.com/static/images/signup.jpg">
    <meta property="og:url" content="https://mcc.backup.miracle44radio.com/dashboard">
    <meta property="og:image:width" content="300">
    <meta property="og:image:height" content="300">
    <meta property="og:type" content="website" />
    <meta property="og:image:type" content="image/png">

    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="{{url_for('static', filename='css/upload_folder_s.css')}}">
    <style>
.tab-content {
      display: none;
  }
  
  .tab-content.active {
      display: block;
  }

    .name-container h5 {
        margin-bottom: 0.2rem; /* Adjust the margin as needed */
    }
    .name-container small {
        margin-top: 0; /* Adjust the margin as needed */
    }

    .gradient-custom {
      /* fallback for old browsers */
      background: #f6d365;
      
      /* Chrome 10-25, Safari 5.1-6 */
      background: -webkit-linear-gradient(to right bottom, rgba(246, 211, 101, 1), rgba(253, 160, 133, 1));
      
      /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */
      background: linear-gradient(to right bottom, rgba(246, 211, 101, 1), rgba(253, 160, 133, 1))
      }
        header{
               background:#fff;height:100px;
               line-height:100px;
               padding:0 30px;
               z-index:999}

               .folder-title{
                margin-bottom: 20px;
               }    
          
               .navbar-brand{
                display: none;
               }
             
            .icon{
               /* display: none !important;  */
               /* font-size: 10px; */
             }
             @media screen and (max-width: 1204px) {
                .icon{
               /* display: none !important;  */
               font-size: 20px;
             }
             .nav-link{
                font-size: 12px;
            }

             }

             @media screen and (max-width: 990px) {

                .icon{
               /* display: none !important;  */
               font-size: 10px;
             }
             .nav-link{
                font-size: 8px;
            }

             }

               @media screen and (max-width: 760px) {

                .navbar-nav {
                  line-height: 10px !important;
                }   
  
            
                .logo_im{
                    display: none !important;
                }
                header{
               padding:0 30px;
               z-index:999}

               .navbar-brand{
                display:block;
               }
              
               .folder {
                width: 90px;
                height: 90px;
                font-size: 14px;
                line-height: 2px;
                width: 110px;
            }

            .folder, .item {
                margin-right: 13px;
            }
            
            .list-group{
              font-size: 10px;
            }
            .btn-device{
            font-size: 10px;
            }
         
               }

               @media (min-width: 576px) {
                .container, .container-sm {
                    /* max-width: 740px; */
                }
            }

               @media screen and (max-width: 446px) {
              
               }
              ul,li{
                width: 40%;
               }

    </style>
</head>
<body>
<div class="container">
    <section class="py-4">
        <header>
        <div class="container-fluid">
            <div class="row">
                <div class="col">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center logo_im">
                          <a class="nav-link" rel="canonical" href="#">
                            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Robert Kayanja Ministries" width="54" height="50">
                          </a>
                          <span class="ms-2">RKM Backup Center</span>
                        </div>
                        <div class="d-flex align-items-center">
                          <div class="me-3" style="line-height: 1 !important;">
                            <h5 id="name-profile" title="">Nsamb Isaac</h5>
                            <small class="text-muted" id="date-ms">Someone famous in</small>
                          </div>
                          <button type="button" class="btn btn-info" id="logoutId">LogOut</button>
                        </div>
                      </div>
                </div>
            </div>

            <div class="row">
              <div class="alert alert-primary" role="alert" id="notification"></div>
            </div>

            <div class="row">
                <div class="col ">
            
                      <nav class="navbar navbar-expand-md navbar-light bg-light">
                        <div class="container-fluid">
                          <!-- Brand/logo -->
                          <a class="navbar-brand" href="#"> <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Robert Kayanja Ministries" width="54" height="50">
                            <span class="ms-2">RKM Backup Center</span>
                        </a>
                    
                          <!-- Toggle button for mobile -->
                          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                            <span class="navbar-toggler-icon"></span>
                          </button>
                    
                          <!-- Navbar items -->
                          <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                            <ul class="navbar-nav">
                              <li id="tabHelp" class="nav-item">
                                <a class="nav-link" href="#" onclick="switchTab('tabHelp'); return false;"><i class="fa fa-question-circle-o fa-lg icon"></i> Help</a>
                              </li>
                              <li id="tabDashboard" class="nav-item">
                                <a class="nav-link" href="#" onclick="switchTab('tabDashboard'); return false;"><i class="fa fa-tachometer fa-lg icon"></i> Dashboard</a>
                              </li>
                              <li id="tabProfile" class="nav-item">
                                <a class="nav-link" href="#" onclick="switchTab('tabProfile'); return false;"><i class="fa fa-user fa-lg icon"></i> My Profile</a>
                              </li>
                                
                              </li>
                            </ul>
                          </div>
                        </div>
                      </nav>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                        Add new Folder
                      </button>
                  
                      <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                        <div class="modal-dialog">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title" id="staticBackdropLabel">Create new Folder</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                              <input type="text" id="folderInput" class="form-control" placeholder="Create a Folder" aria-label="Create a Folder" aria-describedby="button-addon2">
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                              <button type="submit" class="btn btn-primary" id="createFolder">Create</button>
                            </div>
                          </div>
                        </div>
                      </div>
                </div>
                <div class="col"></div>
            </div>

            <div class="row">
                 <div class="col-lg-8 py-6 mb-5">
                    <div class="row h-100 align-items-center justify-content-center">
                        <!-- left part -->
                    <div id="tabHelpContent" class="tab-content">
                        <h3>Help Content</h3>
                        <p>This is the help section.</p>
                      </div>
                
                      <div id="tabDashboardContent" class="tab-content"></div>
                
                      <div id="fileListContainer" class="mt-3" style="display: none;">
                        <button id="backButton" class="btn btn-primary mb-3">Back to Folders</button>
                        <h2>Files</h2>
                      </div>
                
                      <div id="tabProfileContent" class="tab-content">
                        <h3>My Profile Content</h3>
                        {% include "partial.html" %}
                      </div>
                    <!-- end of left section -->
                    </div>
                 </div>
                 <div class="col-lg-4 py-6 mb-5">
                    <div class="row h-100 align-items-center justify-content-center">
                    <!-- Right part  -->
                    <div class="input-select-wrap text-center">
                        <div class="fileUpload">
                          <a href="/uploadfiles">
                            <span>+</span>
                            <p>Add your files</p>
                          </a>
                        </div>
                      </div>
                    </div>
                 </div>
            </div>
        </header>
        </div>
    </section>
</div>

<script>
    //document.addEventListener("DOMContentLoaded", function(){
    var user_email = "";
     console.log("main Log.....");
    
      function switchTab(tabId) {
    
        console.log("function clicked");
    
        const tabs = document.querySelectorAll('.nav-item');
        tabs.forEach(tab => tab.classList.remove('active'));
        const tabContent = document.querySelectorAll('.tab-content');
        tabContent.forEach(content => content.classList.remove('active'));
    
        // adding 'active' class to the clicked tab and content
        const clickedTab = document.getElementById(tabId);
        clickedTab.classList.add('active')
    
        if (tabId === 'tabDashboardContent'){
          document.getElementById('fileListContainer').style.display = 'block'
        }else{
          document.getElementById('fileListContainer').style.display = 'none'
        }
    
        const contentId = `${tabId}Content`;
        const clickedContent = document.getElementById(contentId);
        clickedContent.classList.add('active')
      //}
    };
    
    // Set the default active tab on page load
    document.addEventListener('DOMContentLoaded', function() {
    
      const defaultTab = "tabDashboard"
      const token = "{{ token }}";
      const profile_name = document.getElementById("name-profile");
      const user_profileEmail = document.getElementById("user_profile_email");
      const user_profileName = document.getElementById("user_profile_name");
      const profile_user_date = document.getElementById("profile_date");
      var   holderEmail = document.getElementById("message");

      const signoutBtn = document.getElementById('logoutId');

      signoutBtn.addEventListener('click', function(){
        fetch('/api/logout',{
          method:"GET",
          headers:{
            "Accept":'application/json'
          }
        })
         .then((response)=>{
          if(response.status == 200){
            console.log("Logged out...");
            location.reload();
          }
          else {
            console.error('Failed to log out:', response.status, response.statusText);
        }
          //console.log("Loggedout...")
        }).catch((e)=> console.error(e))
      });
      
      const date_created = document.getElementById("date-ms")
     // console.log("Token:", token);
    
      switchTab(defaultTab)
    
      fetch('/api/user/me',{
        method:"GET",
        headers:{ 
          "Content-Type": "application/json",
          "Authorization":`Bearer ${token}`
        },
        }).then((response) =>{
    
          if (response.status === 200) {
           return response.json();
          }else{
    
            throw new Error("Something went wrong on API!");
    
          }
        }).then((resp)=>{
         profile_name.innerText= `${resp.name}`;
         user_profile_name.innerText =  `${resp.name}`;
         user_profileEmail.innerText =  `${resp.email}`;
         user_email = `${resp.email}`;
         const dateOn = `${resp.date_created}`
         const dateObject = new Date(dateOn);
         //date_created.innerText= `${dateObject.toLocaleString()}`;
         const formattedDate = dateObject.toLocaleDateString('en-US', {
          weekday: 'short', // Abbreviated day of the week (e.g., Wed)
          year: 'numeric',  // Full year (e.g., 2024)
          month: 'short',   // Abbreviated month name (e.g., Jun)
          day: 'numeric'    // Day of the month (e.g., 24)
      });
    
      date_created.innerText= `${formattedDate}`;
      profile_user_date.innerText = `${formattedDate}`;
      holderEmail.innerText =  `${resp.email}`;
    
        // console.log("Rsult:",formattedDate);
    
        }).catch((error)=>{
    
          console.error(error);
    
        })
    
    });
    
    function get_all_folders(){
      fetch("/get_all_buckets", {
        method:"GET", 
        headers:{
          "Accept":"application/json"
        }
      }).then((response)=>{
        if (response.status == 200){
          return response.json()
        }
        
      }).then((data) => {
        console.log("FOLDERS",data.length)
      // creating folder HTML 
      const folderContainer = document.getElementById('tabDashboardContent');
      
      if(data.length > 0){
        data.forEach((folder,index) =>{
      
          const folderDiv = document.createElement('Div');
          folderDiv.className = 'top-droppable folder tooltiper tooltiper-up mb-4';
          folderDiv.dataset.tooltip = '0 file';
          folderDiv.id =`folder${index + 1}`;
      
          folderDiv.innerHTML = `
          <i class="fa fa-folder" aria-hidden="true"></i>
          <i class="fa fa-check" aria-hidden="true"></i>
          <p class="folder-title">${folder}</p>
          `;
    
          folderDiv.addEventListener("click", function(){
           fetchallFiles(folder);
          });
      
          folderContainer.appendChild(folderDiv);
          
        });
      } else {
      
        const noFoldersDiv = document.createElement('div');
        noFoldersDiv.className = 'alert alert-warning';
        noFoldersDiv.textContent = 'No folders found';
        folderContainer.appendChild(noFoldersDiv);
       
      }
        
      }).catch((error)=> console.error('Error fetch folder list:', error));
    }
    
    get_all_folders();
    // Model create Folder MOdel 
    
    document.getElementById("createFolder").addEventListener("click", function(event){
      //event.preventDefault();
      var folderInput =  document.getElementById("folderInput").value;
      console.log("submitting");
      if (folderInput){
        var modal = bootstrap.Modal.getInstance(document.getElementById('staticBackdrop'));
        var content = {
          "folder_name":folderInput
        }
        fetch('/create_b2_folder',{
          method:"POST",
          headers:{
            "Content-Type":"application/json"
          },
          body:JSON.stringify(content)
        }).then((response) =>{
          if (response.status == 200){
            return response.json()
          }
        }).then((data)=>{
          console.log("success");
          alert(data.message);
         location.reload();
        }).catch((error)=> console.error(error));
         modal.hide();
    
      }else{
        alert("Enter FOlder name");
      }
    
    });
    
    const creatFolderBtn = document.getElementById("createFolder").addEventListener("click", function(event){
      //event.preventDefault();
      var folderInput =  document.getElementById("folderInput").value;
      if (folderInput){
        var modal = bootstrap.Modal.getInstance(document.getElementById('staticBackdrop'));
        
         modal.hide();
      }
    
    })
    
    function fetchallFiles(folderName){
      console.log(`Sending folder name: ${folderName}`);
    
      fetch('/list_all_files',{
        method:"POST",
        headers:{
          "Content-Type":"application/json"
        },
        body:JSON.stringify({folder_name: folderName})
      })
      .then((response) =>{
        if (response.status == 200){
          return response.json();
        }
      })
      .then((data) => {
    
        console.log(data);
        var files_ = []
        
        //if(typeof data.files == 'string'){
         
          files_ = [data.files];
       
        //  }else if (Array.isArray(data.files)) {
         
          //  files_ = data.files;  // If it's already an array, use it directly
      //}
    
      
    
        //console.log(files_);
    
        const foldercontainer = document.getElementById("tabDashboardContent");
        const fileListContainer = document.getElementById('fileListContainer');
        const filelist = document.createElement('ul')
        filelist.className = 'list-group w-100';
        fileListContainer.innerHTML = '<button id="backButton" class="btn btn-danger mb-2 small" style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">Back to Folders</button><h2>Files</h2>';
    
        if(data.files.length > 0){
           data.files.forEach(file => {
           const fileItem = document.createElement('li');
           fileItem.className = 'list-group-item d-flex justify-content-between align-items-center w-100';
           //fileItem.innerHTML = '<button type="button" class="btn btn-outline-success">Success</button><button type="button" class="btn btn-outline-danger">Danger</button>'
    
           const fileText = document.createTextNode(file);
           fileItem.appendChild(fileText);
    
           const divContainer = document.createElement('div');
           divContainer.className = "d-flex justify-content-between align-items-center w-5"
           fileItem.appendChild(divContainer)
           
           const successbtn = document.createElement("a");
           successbtn.type = 'button';
           successbtn.className = 'btn btn-device btn-outline-success';
           successbtn.textContent = 'Download';
           successbtn.href ="#"
           successbtn.setAttribute('download','');
           
           divContainer.appendChild(successbtn);
    
           successbtn.addEventListener('click', function(){
            
           })
    
           const dangerButton = document.createElement('button');
           dangerButton.type = 'button';
           dangerButton.className = 'btn btn-device btn-outline-danger';
           dangerButton.textContent = 'Delete';
           divContainer.appendChild(dangerButton);
    
          // fileItem.textContent = file;
           filelist.appendChild(fileItem);
          });
        } else {
    
          const noFilesItem = document.createElement('li');
    
          noFilesItem.className = 'list-group-item';
          noFilesItem.textContent = 'No files found';
          filelist.appendChild(noFilesItem);
        }
       // if ()
       fileListContainer.appendChild(filelist);
       fileListContainer.style.display = 'block'
       foldercontainer.style.display = 'none';
    
       document.getElementById('backButton').addEventListener('click', function(){
        location.reload();
        fileListContainer.style.display = 'none';
        foldercontainer.style.display = 'block';
       })
    
      })
      .catch((error) => console.error("Error fetching file list:", error));
    }

   // Change password functionalitry

   document.addEventListener('DOMContentLoaded', (event) => {
    //var myModal = new bootstrap.Modal(document.getElementById('rmkModal'), {});
    //myModal.show();

    document.getElementById("resetPassword").addEventListener("click", function(){

      if(user_email){
          user_data = {
        email:user_email
      }

      var modal = bootstrap.Modal.getInstance(document.getElementById('staticBackdropOne'));
      }
    

  
            

     
      fetch('/forgot_password', {
        method:"POST",
        headers:{
          "Accept":"application/json",
          "Content-Type":"application/json",
        },
        body:JSON.stringify(user_data)
      }).then((response)=>{
        if (response.status == 200){
          return response.json()
        }else{
          console.error("There was Error requesting Password Reset..!")
        }
      }).then((data)=> {
        console.log("Email Send ", data)
        modal.hide();
        if(modal.hide()){
          alert(data['message'])
        }

        const notificationElement = document.createElement('div');
        notificationElement.className ="alert alert-succes";
        notificationElement.setAttribute("alert","role");
        notificationElement.textContent = data['message'];
      
      }).catch((error) => console.error(error))
    });


  });
 </script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>